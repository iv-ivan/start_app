# AWS cloud deploy
Now let's launch a bunch of AWS services to host our backend.

_Note: The price of AWS for me was 3\$ for buying the domain, and 7\$ per month in total. Check your Billing on a daily basis_

## CDK
Historical evolution of cloud infra handling:
1) In "old good times" AWS services were usually launched through API calls (or through UI).

2) Then, IaC (InfrastructureAsCode) approach was invented. 
    - Instead of scripts with API calls, we define infrastructure state (all resources) in files. On file changes delta updates are applied to update AWS services.

3) But what if we have repeating resources, or a lot of cross-dependencies between them?
It would be handy to use "coding" approach to reduce copypaste. 
    - A dummy approach is to generate IaC file using any programming language and template engine. 
    - That's basically what AWS CDK is doing

AWS CDK allows defining [Infrastructure as Code](https://aws.amazon.com/what-is/iac/) using JS/Python etc.

## Instructions

The basic tutorial for CDK can be found [here](https://docs.aws.amazon.com/cdk/v2/guide/hello_world.html
)

1) Install AWS cdk
```shell
# install nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash

# Close + reopen terminal window

# install node
nvm install 22

# install cdk
npm install -g aws-cdk
```

2) Init cdk for our project:
```shell
mkdir backend_cdk
cd backend_cdk
cdk init app --language python
```

3) Autogenerated `README.md` there is quite useful, check it
   - Not mentioned in `README.md`: to deactivate python env type `deactivate`

4) Now, buy a domain to make our API available in the internet.
   1) Open https://us-east-1.console.aws.amazon.com/route53/domains/ 
   2) Proceed to "Register domains"
   3) _Note 1:_ AWS doesn't allow buying domains for newly created accounts before they pass some internal verifications. Don't hesitate to write to Support in case of errors, they will help you.
   4) Buying a domain outside of AWS is not an option for this tutorial - it can't be transferred to AWS in the first 60 days; editing DNS records manually outside of AWS requires much more work.


5) Write CDK code:
```
1) Check this code:
backend/backend_cdk/backend_cdk/backend_cdk_stack.py
backend/backend_cdk/app.py

2) Replace ACCOUNT_ID and DOMAIN in the code with yours.

3) You may have 2 situations:
  - You have your domain
  - You don't have your domain
If you don't have a domain yet, you need to comment some code.
```

6) Deploy:
```shell
cdk bootstrap aws://<account-id>/eu-west-1
cdk deploy ApiStack
cdk bootstrap aws://<account-id>/us-east-1
cdk deploy CloudfrontStack
```

7) Check that everything works
```
# Go to https://eu-west-1.console.aws.amazon.com/ec2/home?region=eu-west-1#LoadBalancers:
# and copy your ALB DNS name

## Test requesting via ALB name:
curl -v http://<ALB_DNS_NAME>/items/5?q=qwerty
# Response:{"item_id":5,"q":"qwerty"}

## Test requesting via internal domain with HTTPS and HTTP:
curl -v https://api-int.<YOUR_DOMAIN>/items/5?q=asdfg
curl -v http://api-int.<YOUR_DOMAIN>/items/5?q=asdfg

## Test requesting via CLoudfront with HTTPS only:
curl -v https://api.<YOUR_DOMAIN>/items/5?q=zxcvb
```

8) To shut down all the infra simply run:
```
cdk destroy ApiStack
cdk destroy CloudfrontStack
```

_Note: You may still need to cleanup some resources manually, check AWS Billing dashboard after 1-2 days._